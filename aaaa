import React, { useEffect, useState } from 'react';
import { useNavigate, useLocation } from 'react-router-dom';

import { useLiveOccupancy } from '../hooks/useLiveOccupancy';

import wuLogo from '../assets/wu-logo.png';
import indiaFlag from '../assets/flags/india.png';
import phFlag from '../assets/flags/philippines.png';
import japanFlag from '../assets/flags/japan.png';
import malaysiaFlag from '../assets/flags/malaysia.png';

import { apacPartitionList as partitionList } from '../api/occupancy.service';

export default function Header() {
  const navigate = useNavigate();
  const loc = useLocation();
  const { data } = useLiveOccupancy(1000);
  const [lastUpdate, setLastUpdate] = useState('');

  useEffect(() => {
    if (data) {
      setLastUpdate(new Date().toLocaleTimeString());
    }
  }, [data]);

  const parts = loc.pathname.split('/').filter(Boolean);
  const isPart = parts[0] === 'partition' && parts[1];
  const current = isPart ? decodeURIComponent(parts[1]) : '';
  const isHome = loc.pathname === '/';

  const flagMap = {
    'Pune': indiaFlag,
    'Quezon City': phFlag,
    'JP.Tokyo': japanFlag,
    'MY.Kuala Lumpur': malaysiaFlag,
    'Taguig City': phFlag
  };

  return (
    <header className="bg-black text-white mb-4 shadow-md">
      <div className="container mx-auto flex items-center justify-between px-4 py-3 flex-wrap">
        {/* Left: Logo + Title + Navigation Icons */}
        <div className="flex items-center space-x-4">
          <img src={wuLogo} alt="WU" className="h-10" />

          <h1 className="text-xl sm:text-2xl font-semibold text-yellow-400 whitespace-nowrap">
            APAC Occupancy {current && <span className="text-white">• {current}</span>}
          </h1>

          <div className="hidden sm:flex space-x-2">
            <button
              onClick={() => navigate('/')}
              className="text-white hover:text-yellow-400"
              title="Home"
            >
              <i className="fas fa-home text-lg"></i>
            </button>

            <button
              onClick={() => navigate('/history')}
              className="text-white hover:text-yellow-400"
              title="History"
            >
              <i className="fas fa-clock text-lg"></i>
            </button>

            {(isHome || isPart) && (
              <button
                onClick={() =>
                  navigate(`/partition/${encodeURIComponent(current || 'Pune')}/details`)
                }
                className="text-white hover:text-yellow-400"
                title="Details"
              >
                <i className="fas fa-list text-lg"></i>
              </button>
            )}
          </div>
        </div>

        {/* Right: Partition Select */}
        <div className="mt-2 sm:mt-0">
          <select
            value={current}
            onChange={e => navigate(e.target.value || '/')}
            className="bg-white text-black px-3 py-1 rounded focus:outline-none min-w-[160px]"
          >
            <option value="">— Select Site —</option>
            {partitionList.map(p => (
              <option key={p} value={`/partition/${encodeURIComponent(p)}`}>
                {p}
              </option>
            ))}
          </select>
        </div>
      </div>
    </header>
  );
}