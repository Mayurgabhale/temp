const BASE = process.env.REACT_APP_API_BASE || 'http://localhost:3007';

// In-memory cache
const cache = {
  liveSummary: null,
  history: new Map(), // key: partition code or 'global'
};

/**
 * Fetch APAC live summary and cache it
 */
export async function fetchLiveSummary() {
  if (cache.liveSummary) {
    return cache.liveSummary;
  }

  const res = await fetch(`${BASE}/api/occupancy/live-summary`);
  if (!res.ok) throw new Error(`Live summary fetch failed: ${res.status}`);

  const json = await res.json();
  if (!json.success) throw new Error('Live summary response not successful');

  cache.liveSummary = json;
  return json;
}

/**
 * Fetch history (global or per-site), caching for session.
 * @param {string} [site] â€” partition identifier, e.g. 'PH.Manila'
 */
export async function fetchHistory(site) {
  const key = site || 'global';
  if (cache.history.has(key)) {
    return cache.history.get(key);
  }

  const url = site
    ? `${BASE}/api/occupancy/history?site=${encodeURIComponent(site)}`
    : `${BASE}/api/occupancy/history`;

  const res = await fetch(url);
  if (!res.ok) throw new Error(`History fetch failed: ${res.status}`);

  const json = await res.json();
  if (!json.success) throw new Error('History response not successful');

  cache.history.set(key, json);
  return json;
}

/**
 * Clear APAC data cache
 */
export function clearCache() {
  cache.liveSummary = null;
  cache.history.clear();
}

// --- List of APAC partitions for the dashboard
export const partitionList = [
  'IN.Pune',
  'PH.Manila',
  'PH.Quezon City',
  'PH.Taguig City',
  'MY.Kuala Lumpur',
  'JP.Tokyo'
];