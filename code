// Collect unique cities for filter
const uniqueCities = [...new Set(devices.map(dev => dev.city).filter(Boolean))].sort();

// Populate city filter dropdown
const cityFilter = document.getElementById('cityFilter');
if (cityFilter) {
  cityFilter.innerHTML = '<option value="all">All Cities</option>';
  uniqueCities.forEach(city => {
    const option = document.createElement('option');
    option.value = city;
    option.textContent = city;
    cityFilter.appendChild(option);
  });
}







const rawHist   = historyData[ip] || [];
const city      = dev.city || 'Unknown';





devices.push({ ip, safe, name, category, rawHist, hist, status, downCount, city });






function filterData() {
  const typeSel     = document.getElementById('device-type').value.toUpperCase();
  const remarkSel   = document.getElementById('remark-filter').value.toUpperCase();
  const citySel     = document.getElementById('cityFilter')?.value.toUpperCase() || "ALL";
  const searchTxt   = document.getElementById('search-input').value.toUpperCase();

  document.querySelectorAll('#device-table tbody tr').forEach(r => {
    const ip     = r.cells[1].textContent.toUpperCase();
    const name   = r.cells[2].textContent.toUpperCase();
    const type   = r.cells[3].textContent.toUpperCase();
    const city   = r.cells[8]?.dataset?.city?.toUpperCase() || r.cells[4].textContent.toUpperCase(); // fallback
    const remark = r.cells[8]?.textContent.toUpperCase();

    const matchesType   = (typeSel === 'ALL' || type === typeSel);
    const matchesRemark = (remarkSel === 'ALL' || remark.includes(remarkSel));
    const matchesCity   = (citySel === 'ALL' || city === citySel);
    const matchesSearch = (ip.includes(searchTxt) || name.includes(searchTxt));

    r.style.display = matchesType && matchesRemark && matchesCity && matchesSearch ? '' : 'none';
  });
}








row.innerHTML = `
<td>${i+1}</td>
<td><span id="ip-${d.safe}" class="copy-text" onclick="copyToClipboard('ip-${d.safe}')">${d.ip}</span></td>
<td><span id="name-${d.safe}" class="copy-text" onclick="copyToClipboard('name-${d.safe}')">${d.name}</span></td>
<td>${d.category}</td>
<td>${d.city}</td>
<td id="uptime-${d.safe}">0h/0m/0s</td>
<td id="downtime-count-${d.safe}">${d.downCount}</td>
<td id="downtime-${d.safe}">0h/0m/0s</td>
<td><button class="history-btn" onclick="openDeviceHistory('${d.ip}','${d.name}','${d.category}')">View History</button></td>
<td id="remark-${d.safe}" data-city="${d.city}">–</td>
`;






document.addEventListener('DOMContentLoaded', () => {
  ['region', 'device-type', 'remark-filter'].forEach(id => {
    document.getElementById(id)?.addEventListener('change', id === 'region' ? fetchDeviceData : filterData);
  });

  document.getElementById('search-input')?.addEventListener('input', filterData);

  // ✅ Add cityFilter event
  document.getElementById('cityFilter')?.addEventListener('change', filterData);

  fetchDeviceData();
});