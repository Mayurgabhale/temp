function displayDeviceHistory(deviceIp, deviceName, history) {
    const modalHeader = document.getElementById('device-history-header');
    const historyContainer = document.getElementById('device-history');

    modalHeader.innerHTML = `
        <h3>Device History</h3>
        <p><strong>Device Name:</strong> ${deviceName}</p>
        <p><strong>Device IP:</strong> ${deviceIp}</p>
        <hr>
    `;

    historyContainer.innerHTML = '';

    if (history.length === 0) {
        historyContainer.innerHTML = `<p>No history available for this device.</p>`;
        return;
    }

    let tableHTML = `
        <table border="1" style="width:100%; text-align:center; border-collapse: collapse;">
            <thead>
                <tr>
                    <th>Sr.No</th>
                    <th>Date</th>
                    <th>Day</th>
                    <th>Time</th>
                    <th>Status</th>
                    <th>Downtime Duration</th>
                </tr>
            </thead>
            <tbody>
    `;

    let lastOfflineTimestamp = null;
    let rowCounter = 1;

    history.forEach((entry, index) => {
        const entryDate = new Date(entry.timestamp);
        const formattedDate = entryDate.toLocaleDateString();
        const formattedTime = entryDate.toLocaleTimeString();
        const formattedDay = entryDate.toLocaleString('en-US', { weekday: 'long' });

        let downtimeDuration = "-";

        if (entry.status === "Offline") {
            lastOfflineTimestamp = entry.timestamp;
        } else if (entry.status === "Online" && lastOfflineTimestamp) {
            const offlineStart = new Date(lastOfflineTimestamp).getTime();
            const onlineTime = new Date(entry.timestamp).getTime();
            const durationSec = (onlineTime - offlineStart) / 1000;

            if (durationSec >= 300) {
                downtimeDuration = formatDuration(durationSec);

                tableHTML += `
                    <tr>
                        <td>${rowCounter++}</td>
                        <td>${formattedDate}</td>
                        <td>${formattedDay}</td>
                        <td>${formattedTime}</td>
                        <td style="color: red;">Offline</td>
                        <td>${downtimeDuration}</td>
                    </tr>
                `;
            }

            lastOfflineTimestamp = null; // Reset for next cycle
        }
    });

    tableHTML += `</tbody></table>`;

    historyContainer.innerHTML = `
        <div class="scrollable-history-table">
            ${tableHTML}
        </div>
    `;
}