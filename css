deviceList.forEach(device => {
  const deviceHistory = getDeviceHistory(device.ip); // your method
  const downtimeCount = countValidDowntimes(deviceHistory, device.category);
  const downtimeDurationSec = sumValidDowntimeDuration(deviceHistory, device.category);

  // Update table cell values
  const safeIp = device.ip.replace(/\./g, "-");

  document.getElementById(`downtime-count-${safeIp}`).textContent = downtimeCount;
  document.getElementById(`downtime-${safeIp}`).textContent = formatDuration(downtimeDurationSec);
});







function countValidDowntimes(history, deviceCategory) {
  let count = 0;
  let lastOffline = null;

  for (let i = 0; i < history.length; i++) {
    const entry = history[i];
    if (entry.status === "Offline") {
      lastOffline = entry;
    } else if (entry.status === "Online" && lastOffline) {
      const offlineTime = new Date(lastOffline.timestamp).getTime();
      const onlineTime = new Date(entry.timestamp).getTime();
      const durationSec = (onlineTime - offlineTime) / 1000;

      if (deviceCategory === "SERVER" || durationSec >= 300) {
        count++;
      }

      lastOffline = null;
    }
  }

  // Still offline right now? Count it
  if (lastOffline) {
    const offlineTime = new Date(lastOffline.timestamp).getTime();
    const now = Date.now();
    const durationSec = (now - offlineTime) / 1000;

    if (deviceCategory === "SERVER" || durationSec >= 300) {
      count++;
    }
  }

  return count;
}







function sumValidDowntimeDuration(history, deviceCategory) {
  let total = 0;
  let lastOffline = null;

  for (let i = 0; i < history.length; i++) {
    const entry = history[i];
    if (entry.status === "Offline") {
      lastOffline = entry;
    } else if (entry.status === "Online" && lastOffline) {
      const offlineTime = new Date(lastOffline.timestamp).getTime();
      const onlineTime = new Date(entry.timestamp).getTime();
      const durationSec = (onlineTime - offlineTime) / 1000;

      if (deviceCategory === "SERVER" || durationSec >= 300) {
        total += durationSec;
      }

      lastOffline = null;
    }
  }

  if (lastOffline) {
    const durationSec = (Date.now() - new Date(lastOffline.timestamp).getTime()) / 1000;
    if (deviceCategory === "SERVER" || durationSec >= 300) {
      total += durationSec;
    }
  }

  return total;
}