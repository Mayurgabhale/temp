const handleGenerate = async () => {
  setLoading(true);
  try {
    const baseParams = {
      region,
      location: location || undefined
    };

    // Helper function to format dates with time
    const formatDateWithTime = (date, endOfDay = false) => {
      const d = new Date(date);
      if (endOfDay) {
        d.setHours(23, 59, 59, 999);
      } else {
        d.setHours(0, 0, 0, 0);
      }
      return d.toISOString();
    };

    if (tab === 0) {
      // Daily Access - already correct
      const params = {
        ...baseParams,
        from: formatDateWithTime(from),
        to: formatDateWithTime(to, true),
        employees: selectedEmps.join(',')
      };
      const resp = await axios.get('/api/reports/daily-access', { params });
      await generateDailyAccessExcel(resp.data.data);
    }
    else if (tab === 1) {
      // Raw - modified to include time
      const params = {
        ...baseParams,
        startDate: formatDateWithTime(from),
        endDate: formatDateWithTime(to, true)
      };
      const resp = await axios.get('/api/reports/raw', { params });
      // filter by date range
      const startDate = new Date(params.startDate);
      const endDate = new Date(params.endDate);
      const rows = resp.data.data.filter(r => {
        const dateStr = r.DateOnly || r.LocaleMessageTime;
        const date = new Date(dateStr);
        return date >= startDate && date <= endDate;
      });
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Raw');
      XLSX.writeFile(wb, `RawReport_${region}_${startDate.toISOString().slice(0, 10)}_to_${endDate.toISOString().slice(0, 10)}.xlsx`);
    }
    else if (tab === 2) {
      // Rejection - modified to include time
      const params = {
        ...baseParams,
        startDate: formatDateWithTime(from),
        endDate: formatDateWithTime(to, true)
      };
      const resp = await axios.get('/api/reports/rejection', { params });
      const startDate = new Date(params.startDate);
      const endDate = new Date(params.endDate);
      const rows = resp.data.data.filter(r => {
        const dateStr = r.DateOnly || r.LocaleMessageTime;
        const date = new Date(dateStr);
        return date >= startDate && date <= endDate;
      });
      await generateRejectionExcel(rows);
    }
    else if (tab === 3) {
      // Time Duration - modified to include time
      const params = {
        ...baseParams,
        startDate: formatDateWithTime(from),
        endDate: formatDateWithTime(to, true),
        partition: location.split('.').pop()
      };
      const resp = await axios.get('/api/reports/time-duration', { params });
      await generateTimeDurationExcel(resp.data.data);
    }
  } catch (err) {
    console.error(err);
    alert('Failed to generate report');
  } finally {
    setLoading(false);
  }
};