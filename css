function displayDeviceHistory(deviceIp, deviceName, history) {
    const modalHeader = document.getElementById('device-history-header');
    const historyContainer = document.getElementById('device-history');

    modalHeader.innerHTML = `
        <h3>Device History</h3>
        <p><strong>Device Name:</strong> ${deviceName}</p>
        <p><strong>Device IP:</strong> ${deviceIp}</p>
        <hr>
    `;

    historyContainer.innerHTML = '';

    if (history.length === 0) {
        historyContainer.innerHTML = `<p>No history available for this device.</p>`;
        return;
    }

    let tableHTML = `
        <table border="1" style="width:100%; text-align:center; border-collapse: collapse;">
            <thead>
                <tr>
                    <th>Sr.No</th>
                    <th>Date</th>
                    <th>Day</th>
                    <th>Time</th>
                    <th>Status</th>
                    <th>Downtime Duration</th>
                </tr>
            </thead>
            <tbody>
    `;

    let rowCounter = 1;
    let lastOffline = null;

    for (let i = 0; i < history.length; i++) {
        const entry = history[i];

        if (entry.status === "Offline") {
            lastOffline = entry;
        } else if (entry.status === "Online" && lastOffline) {
            const offlineTime = new Date(lastOffline.timestamp);
            const onlineTime = new Date(entry.timestamp);
            const durationSec = (onlineTime - offlineTime) / 1000;

            if (durationSec >= 300) {
                const formattedDate = offlineTime.toLocaleDateString();
                const formattedDay = offlineTime.toLocaleString('en-US', { weekday: 'long' });
                const formattedTime = offlineTime.toLocaleTimeString();
                const downtimeDuration = formatDuration(durationSec);

                tableHTML += `
                    <tr>
                        <td>${rowCounter++}</td>
                        <td>${formattedDate}</td>
                        <td>${formattedDay}</td>
                        <td>${formattedTime}</td>
                        <td style="color: red;">Offline</td>
                        <td>${downtimeDuration}</td>
                    </tr>
                `;
            }

            lastOffline = null;
        }
    }

    tableHTML += `</tbody></table>`;

    if (rowCounter === 1) {
        historyContainer.innerHTML = `<p>No downtime events longer than 5 minutes.</p>`;
    } else {
        historyContainer.innerHTML = `
            <div class="scrollable-history-table">
                ${tableHTML}
            </div>
        `;
    }
}